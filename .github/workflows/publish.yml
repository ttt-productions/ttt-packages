name: Publish Packages to npm

on:
  push:
    tags:
      - "*-v*.*.*"

permissions:
  contents: read
  id-token: write

concurrency:
  group: publish-npm
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Publish package for tag
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"          # e.g. chat-core-v0.2.1
          SLUG="${TAG%-v*}"                 # chat-core
          EXPECT_VER="${TAG#*-v}"           # 0.2.1

          PKGDIR="packages/${SLUG}"
          [[ -f "${PKGDIR}/package.json" ]] || { echo "No package.json at ${PKGDIR}"; exit 1; }

          NAME=$(node -p "require('./${PKGDIR}/package.json').name")
          VER=$(node -p "require('./${PKGDIR}/package.json').version")

          echo "Tag: ${TAG}"
          echo "Package: ${NAME}"
          echo "package.json version: ${VER}"
          echo "expected from tag: ${EXPECT_VER}"

          [[ "${VER}" == "${EXPECT_VER}" ]] || { echo "Version mismatch (tag vs package.json)"; exit 1; }

          if npm view "${NAME}@${VER}" version >/dev/null 2>&1; then
            echo "Already published -> skip"
            exit 0
          fi

          npm publish --access public --provenance --workspace "${NAME}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
