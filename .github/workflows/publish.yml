name: Publish Packages to npm

on:
  push:
    tags:
      - "*-v*.*.*"

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Extract package info from tag
        id: pkg
        run: |
          TAG="${GITHUB_REF_NAME}"
          SLUG="${TAG%-v*}"
          VER="${TAG##*-v}"
          echo "slug=${SLUG}" >> $GITHUB_OUTPUT
          echo "version=${VER}" >> $GITHUB_OUTPUT
          echo "dir=packages/${SLUG}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Build all packages (to ensure dependencies are available)
        run: |
          npm run build -w @ttt-productions/ui-core
          npm run build -w @ttt-productions/theme-core
          npm run build -w @ttt-productions/query-core
          npm run build -w @ttt-productions/monitoring-core
          npm run build -w @ttt-productions/firebase-helpers
          npm run build -w @ttt-productions/media-contracts
          npm run build -w @ttt-productions/media-viewer
          npm run build -w @ttt-productions/chat-core
          npm run build -w @ttt-productions/file-input
          npm run build -w @ttt-productions/auth-core
          npm run build -w @ttt-productions/mobile-core
          npm run build -w @ttt-productions/upload-core
          npm run build -w @ttt-productions/media-processing-core

      - name: Publish package
        shell: bash
        run: |
          set -euo pipefail

          PKGDIR="${{ steps.pkg.outputs.dir }}"
          EXPECT_VER="${{ steps.pkg.outputs.version }}"

          [[ -f "${PKGDIR}/package.json" ]] || { echo "No package.json at ${PKGDIR}"; exit 1; }

          NAME=$(node -p "require('./${PKGDIR}/package.json').name")
          VER=$(node -p "require('./${PKGDIR}/package.json').version")

          echo "Workspace: ${NAME}"
          echo "package.json version: ${VER}"
          echo "expected from tag: ${EXPECT_VER}"

          [[ "${VER}" == "${EXPECT_VER}" ]] || { echo "Version mismatch (tag vs package.json)"; exit 1; }

          if npm view "${NAME}@${VER}" version >/dev/null 2>&1; then
            echo "Already published -> skip"
            exit 0
          fi

          npm publish --access public --provenance --workspace "${NAME}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}